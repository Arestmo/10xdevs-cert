---
/**
 * Auth Callback Page
 *
 * Handles OAuth and Magic Link authentication callbacks from Supabase.
 * Exchanges authorization code for session and redirects to the appropriate page.
 */

const { url } = Astro;
const code = url.searchParams.get("code");
const error = url.searchParams.get("error");
const errorDescription = url.searchParams.get("error_description");

// Handle authentication errors
if (error) {
  console.error("Auth callback error:", error, errorDescription);
  return Astro.redirect("/login?error=" + encodeURIComponent(errorDescription || "Authentication failed"));
}

// Exchange code for session
if (code) {
  const { error: exchangeError } = await Astro.locals.supabase.auth.exchangeCodeForSession(code);

  if (exchangeError) {
    console.error("Code exchange error:", exchangeError);
    return Astro.redirect("/login?error=auth_failed");
  }
}

// Redirect to dashboard or original destination
return Astro.redirect(url.searchParams.get("redirect") || "/dashboard");
---
